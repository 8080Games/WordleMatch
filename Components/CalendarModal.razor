@if (IsOpen)
{
    <div class="calendar-modal-backdrop" @onclick="HandleBackdropClick">
        <div class="calendar-modal puzzle-selector" @onclick:stopPropagation="true">
            <div class="calendar-header">
                <h3>Select a Puzzle</h3>
            </div>

            <div class="puzzle-selector-content">
                <div class="puzzle-input-group">
                    <label for="puzzle-number">Puzzle #:</label>
                    <input type="text"
                           id="puzzle-number"
                           class="puzzle-number-input"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           @bind="selectedGameNumber"
                           @bind:event="oninput"
                           @onchange="UpdateFromInput" />
                </div>

                <div class="puzzle-slider-group">
                    <input type="range"
                           class="puzzle-slider"
                           min="0"
                           max="@maxGameNumber"
                           @bind="selectedGameNumber"
                           @bind:event="oninput"
                           @onchange="UpdateFromSlider" />
                    <div class="slider-labels">
                        <span>0</span>
                        <span>@maxGameNumber</span>
                    </div>
                </div>

                <div class="puzzle-info">
                    @if (selectedGameNumber >= 0 && selectedGameNumber <= maxGameNumber)
                    {
                        var date = GetDateForGameNumber(selectedGameNumber);

                        <div class="puzzle-date-display">
                            <strong>Date:</strong> @date.ToString("MMMM d, yyyy")
                        </div>
                    }
                </div>

                <div class="quick-actions">
                    <button class="quick-action-btn" @onclick="JumpToFirst">First</button>
                    <button class="quick-action-btn" @onclick="JumpToRandom">Random</button>
                    <button class="quick-action-btn" @onclick="JumpToToday">Today</button>
                </div>
            </div>

            <div class="calendar-footer">
                <button class="calendar-close-button secondary" @onclick="CloseModal">Cancel</button>
                <button class="calendar-close-button primary" @onclick="SelectPuzzle">Play Puzzle</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public DateTime SelectedDate { get; set; }

    [Parameter]
    public EventCallback<DateTime> OnDateSelected { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public Dictionary<string, (int gameNumber, string date)> UsedWords { get; set; } = new();

    private static readonly DateTime WordleStartDate = new DateTime(2021, 6, 19);
    private int selectedGameNumber = 0;
    private int maxGameNumber = 0;

    protected override void OnParametersSet()
    {
        // Calculate current max game number (today's puzzle)
        maxGameNumber = (DateTime.Today - WordleStartDate).Days;

        // Set selected game number based on SelectedDate
        selectedGameNumber = (SelectedDate.Date - WordleStartDate).Days;

        // Ensure it's within bounds
        if (selectedGameNumber < 0) selectedGameNumber = 0;
        if (selectedGameNumber > maxGameNumber) selectedGameNumber = maxGameNumber;
    }

    private DateTime GetDateForGameNumber(int gameNumber)
    {
        return WordleStartDate.AddDays(gameNumber);
    }

    private string GetWordForGameNumber(int gameNumber)
    {
        var puzzle = UsedWords.FirstOrDefault(w => w.Value.gameNumber == gameNumber);
        return puzzle.Key ?? string.Empty;
    }

    private void UpdateFromInput()
    {
        // Ensure the value is within bounds
        if (selectedGameNumber < 0) selectedGameNumber = 0;
        if (selectedGameNumber > maxGameNumber) selectedGameNumber = maxGameNumber;
    }

    private void UpdateFromSlider()
    {
        // Slider already handles bounds, just trigger UI update
        StateHasChanged();
    }

    private void JumpToFirst()
    {
        selectedGameNumber = 0;
    }

    private void JumpToRandom()
    {
        var random = new Random();
        selectedGameNumber = random.Next(0, maxGameNumber + 1);
    }

    private void JumpToToday()
    {
        selectedGameNumber = maxGameNumber;
    }

    private async Task SelectPuzzle()
    {
        var selectedDate = GetDateForGameNumber(selectedGameNumber);
        await OnDateSelected.InvokeAsync(selectedDate);
    }

    private async Task CloseModal()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleBackdropClick()
    {
        await OnClose.InvokeAsync();
    }
}
